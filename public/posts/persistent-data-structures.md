---
title: "永続データ構造の基礎"
date: "2025-05-31"
slug: "persistent-data-structures"
category: "アルゴリズム"
excerpt: "破壊的更新を避けて複数のバージョンを保持するデータ構造の考え方を解説します。"
tags: ["データ構造", "永続化", "競技プログラミング"]
---

## はじめに

永続データ構造 (persistent data structure) とは、更新前の状態を保持したまま新しいバージョンを作り出す仕組みを持つデータ構造のことです。主に関数型プログラミングや競技プログラミングで利用されます。

## 部分永続と完全永続

- **部分永続**: 最新バージョンからのみ操作可能で、過去のバージョンは参照だけできる。
- **完全永続**: すべてのバージョンから操作が可能で、そこからさらに新しいバージョンを分岐させられる。

## 例: 永続セグメント木

区間の和や最小値を保持するセグメント木を、ノードのコピーを行うことで永続化できます。変更が必要なノードのみを複製し、残りは既存のノードを共有するため、1 回の更新あたり \(O(\log n)\) の追加メモリで済みます。

```cpp
struct Node {
    int val;
    Node *l, *r;
};

Node* update(Node* t, int idx, int val, int l, int r) {
    Node* res = new Node(*t); // 必要なノードだけコピー
    if (l + 1 == r) {
        res->val = val;
        return res;
    }
    int m = (l + r) / 2;
    if (idx < m) res->l = update(t->l, idx, val, l, m);
    else res->r = update(t->r, idx, val, m, r);
    res->val = res->l->val + res->r->val;
    return res;
}
```

## おわりに

永続データ構造を用いることで、過去の状態を保持しつつ効率的な更新と参照が可能になります。応用例としてバージョン管理システムや一部のクエリ回答アルゴリズムなどが挙げられます。
